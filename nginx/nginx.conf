# Nginx configuration for backend service
# This receives authentication information from the JWT service/Envoy proxy

# Custom log format to include headers for debugging (must be in http context)
log_format detailed '$remote_addr - $remote_user [$time_local] '
                   '"$request" $status $body_bytes_sent '
                   '"$http_referer" "$http_user_agent" '
                   'x_customer_id=$http_x_customer_id '
                   'x_account_id=$http_x_account_id '
                   'x_user_id=$http_x_user_id';

server {
    listen 80;
    server_name localhost;

    # Enable access logging to see what headers are being received
    access_log /var/log/nginx/access_with_headers.log main;
    
    # Main endpoint - shows all received headers
    location / {
        # Add headers for authentication information
        add_header X-Customer-ID $http_x_customer_id always;
        add_header X-Account-ID $http_x_account_id always;
        add_header X-User-ID $http_x_user_id always;
        add_header X-Token-Verified $http_x_token_verified always;
        add_header X-Token-Expiration $http_x_token_expiration always;
        
        # Return all received headers for debugging
        return 200 "Request Method: $request_method
Request URI: $request_uri
All Headers Received:
Host: $http_host
Authorization: [REDACTED]
X-Forwarded-For: $http_x_forwarded_for
X-Forwarded-Proto: $http_x_forwarded_proto
X-Forwarded-Host: $http_x_forwarded_host
X-Real-Ip: $http_x_real_ip
X-Envoy-Internal: $http_x_envoy_internal
X-Envoy-Expected-Rq-Timeout-Ms: $http_x_envoy_expected_rq_timeout_ms
X-Request-Id: $http_x_request_id
X-Customer-ID: $http_x_customer_id
X-Account-ID: $http_x_account_id
X-User-ID: $http_x_user_id
X-Token-Verified: $http_x_token_verified
X-Token-Expiration: $http_x_token_expiration
User-Agent: $http_user_agent
Accept: $http_accept
Content-Type: $content_type
Content-Length: $content_length
";
        add_header Content-Type text/plain;
    }

    # API endpoint - serves static JSON response
    location /api/ {
        add_header Content-Type application/json always;
        return 200 "{\"status\":\"success\",\"message\":\"API response from Nginx backend\",\"timestamp\":$msec,\"auth_info\":{\"customer_id\":\"$http_x_customer_id\",\"account_id\":\"$http_x_account_id\",\"user_id\":\"$http_x_user_id\"},\"request_info\":{\"uri\":\"$request_uri\",\"method\":\"$request_method\",\"remote_addr\":\"$remote_addr\"}}";
    }
    
    # Headers debugging endpoint
    location /headers {
        add_header Content-Type text/plain always;
        return 200 "Auth Headers Received:
Customer ID: $http_x_customer_id
Account ID: $http_x_account_id
User ID: $http_x_user_id

Request Headers:
User-Agent: $http_user_agent
Accept: $http_accept
Host: $host
X-Forwarded-For: $http_x_forwarded_for
X-Forwarded-Proto: $http_x_forwarded_proto
X-Forwarded-Host: $http_x_forwarded_host
";
    }

    # Health check endpoint
    location /health {
        add_header Content-Type text/plain always;
        return 200 "healthy
";
    }
    
    # Set custom access log with detailed format
    access_log /var/log/nginx/access.log detailed;
}